import ex_gleam_secp256k1
import gleam/bit_array
import gleeunit
import gleeunit/should

pub fn main() -> Nil {
  gleeunit.main()
}

// Example test for cryptographic operations
// Note: These tests require nosnos to be properly compiled with Zig
pub fn get_public_key_test() {
  // Example 32-byte secret key (in production, use proper key generation)
  let secret_key = <<1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17,
    18, 19, 20, 21, 22, 23, 24, 25, 26, 27, 28, 29, 30, 31, 32>>

  let public_key = ex_gleam_secp256k1.get_public_key(secret_key)

  // Public key should be 32 bytes
  should.equal(bit_array.byte_size(public_key), 32)
}

pub fn sign_and_verify_test() {
  let secret_key = <<1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17,
    18, 19, 20, 21, 22, 23, 24, 25, 26, 27, 28, 29, 30, 31, 32>>
  let message = <<32, 31, 30, 29, 28, 27, 26, 25, 24, 23, 22, 21, 20, 19, 18,
    17, 16, 15, 14, 13, 12, 11, 10, 9, 8, 7, 6, 5, 4, 3, 2, 1>>

  let public_key = ex_gleam_secp256k1.get_public_key(secret_key)
  let signature = ex_gleam_secp256k1.sign_raw(secret_key, message)

  // Signature should be 64 bytes
  should.equal(bit_array.byte_size(signature), 64)

  // Verify the signature
  let is_valid = ex_gleam_secp256k1.verify_raw(public_key, message, signature)
  should.be_true(is_valid)
}

pub fn nostr_event_test() {
  let secret_key = <<1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17,
    18, 19, 20, 21, 22, 23, 24, 25, 26, 27, 28, 29, 30, 31, 32>>
  let created_at = 1_704_067_200
  let kind = 1
  let tags = bit_array.from_string("[]")
  let content = bit_array.from_string("Hello Nostr!")

  // Sign a Nostr event
  let event =
    ex_gleam_secp256k1.sign(secret_key, created_at, kind, tags, content)

  // Just check that we got an event with correct field sizes
  should.equal(bit_array.byte_size(event.id), 32)
  should.equal(bit_array.byte_size(event.pubkey), 32)
  should.equal(bit_array.byte_size(event.sig), 64)
}

pub fn calculate_event_id_test() {
  let secret_key = <<1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17,
    18, 19, 20, 21, 22, 23, 24, 25, 26, 27, 28, 29, 30, 31, 32>>
  let public_key = ex_gleam_secp256k1.get_public_key(secret_key)
  let created_at = 1_704_067_200
  let kind = 1
  let tags = <<>>
  let content = <<"Hello Nostr!">>

  let event_id =
    ex_gleam_secp256k1.calculate_event_id(
      public_key,
      created_at,
      kind,
      tags,
      content,
    )

  // Event ID should be 32 bytes
  should.equal(bit_array.byte_size(event_id), 32)
}
